notesfile

ttd, december, herded notes about the old pipeline here
nearly all of this you don't need, but you'll go through it to pull out parts or details that are still applicable






================================================================================

  On esbuild limitations: Yes, esbuild can fail on certain patterns. It's designed for statically-analyzable imports. Things that break it:

  - Dynamic require(variable) where the module name isn't a literal string
  - eval() or new Function() that construct module references
  - Conditional requires like if (platform === 'node') require('fs')
  - Some older CJS patterns with circular dependencies
  - Modules that do runtime filesystem probing to find their dependencies

  Twilio and SendGrid are exactly the kind of "enterprise Node SDK" that tends to use these patterns internally. They weren't written with bundlers in mind.





================================================================================

https://www.npmjs.com/package/sharp
https://github.com/lovell/sharp
https://sharp.pixelplumbing.com/
https://github.com/libvips/libvips

sharp is a high-performance node image processing module
some javascript wraps libvips, a native module in C
it works windows/mac/linux but the native binaries are platform-specific

here are easy manual steps to get the binaries for lambda
this is node 22, amazon linux 2023, and amazon's graviton chip

$ npm install --os=linux --cpu=arm64 --libc=glibc sharp@0.34.4








================================================================================

pack

you had configured a custom rollup bundle step for the lambda functions,
but just removed it
it wasn't working--it was packing the library code, which is small to begin with
and then ignoring the node modules folder, which serverless would zip up entirely

also, with it gone, you can start the local server nearly instantly,
and error stacks have findable line numbers

you got net23.zip from 50mb down to 20mb just by chasing away aws-sdk as a dev dependency,
and clumsily, line item excluding the largest node modules that came in as icarus dev dependencies

but, you are still drawn to the JavaScript dream--that since all code can run everywhere,
and transpilation can turn anything into anything,
and tree shaking can remove entire modules and individual functions in a file,
everything is awesome

<rant>
none of that worked, however--
there have been days of fighting to get CommonJS and ESM modules to work with each other,
weaving the boundary means that you have to await import, spreading async upwards and everywhere,
modules like twilio written for require() don't work well when you load them not with require(),
jimp, pure javascript, is prohibitively slower than sharp, which is all native,
and even though cloudflare has a node compatibility flag,
that absolutely does not mean that a worker can load or run a node module
</rant>

but, you could still mess around with the code that gets zipped for lambda
if you do, these are the tools that look promising:

https://parceljs.org/
2017, zero configuration, can struggle with complex mixtures of commonjs and esm

https://www.npmjs.com/package/serverless-bundle
2018, for serverless framework, uses webpack, may handle mixture well

https://esbuild.github.io/
2020, extremely fast, should be able to handle the mixture












