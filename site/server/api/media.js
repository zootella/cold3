
import {
vhsSign,
} from 'icarus'

export default defineEventHandler(async (workerEvent) => {
	return await doorWorker('POST', {actions: ['MediaDemonstrationSign.', 'MediaDemonstrationUpload.', 'UploadHash.'], workerEvent, doorHandleBelow})
})
async function doorHandleBelow({door, body, action, browserHash}) {

	if (action == 'MediaDemonstrationSign.') {

		return {
			success: true,
			source: 'https://vhs.net23.cc/banner.png?'+(await vhsSign('/', Limit.mediaDownload)),
			sticker: Sticker(),
		}
	}

	if (action == 'MediaDemonstrationUpload.') {
		if (!hasTextSame(body.hash, Key('upload demonstration password hash, private'))) return {success: false, reason: 'BadPassword.'}

		return {
			success: true,
			envelope: await sealEnvelope('Net23Upload.', Limit.mediaUpload, {}),//session auth only, per-file tags generated by Lambda
		}
	}

	if (action == 'UploadHash.') {
		//page reports hash information at various stages of upload
		//scenario 1: just browserTipHash (after quick browser hash, for short-circuit check)
		//scenario 2: browserTipHash + browserPieceHash (desktop, after full browser hash)
		//scenario 3: browserTipHash + browserPieceHash + bucketEnvelope (after Lambda verification)

		//tag's tale 5/5: tag arrives at Worker either from page (body.tag) or sealed in bucketEnvelope (letter.tag)
		let info = {
			tag: body.tag,
			filename: body.filename,
			size: body.size,
			browserTipHash: body.browserTipHash,
			browserPieceHash: body.browserPieceHash,//undefined in scenario 1 and on mobile
		}

		//if page sent bucketEnvelope from Lambda, open it to get trusted hash values
		if (body.bucketEnvelope) {
			let letter = await openEnvelope('Net23Bucket.', body.bucketEnvelope)
			info.bucketTipHash = letter.tipHash
			info.bucketPieceHash = letter.pieceHash
			info.bucketKey = letter.key
			info.bucketTag = letter.tag
			info.bucketSize = letter.size
			info.bucketFilename = letter.filename
		}

		log('ðŸ“‹ UploadHash.', look(info))

		//for now, just log and return success
		//later: check database for existing tipHash, compare hashes, record verified files
		return {success: true}
	}
}
